<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Test Case Prioritization</title>
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

        <!-- CSS -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
        <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <link href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css" rel="stylesheet">

        <!-- JavaScript -->
        <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>        
        <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>  
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


    </head>
<body>
    {% include 'navbar.html' %}
    <div class="container">
        <div class="compare-section">
            <h4 class="title"><b>Choose Task ID and Case Title to compare</b></h4>
            <div id="configContainer">
                <!-- Config rows will be added here dynamically -->
            </div>
        
            <div class="row justify-content-end">
                <button type="button" class="col-1 btn btn-primary" id="addConfig">Add More</button>
                <button type="button" class="col-1 btn btn-success" id="clearAllBtn">Clear All</button>
            </div>

            <table class="table" id="detailsTable">              
                        <tbody>
                            <tr><th>Pass/Fail</th><td></td></tr>
                            <tr><th>Tester</th><td></td></tr>
                            <tr><th>Platform Name</th><td></td></tr>
                            <tr><th>SKU</th><td></td></tr>
                            <tr><th>Hw Phase</th><td></td></tr>
                            <tr><th>OBS</th><td></td></tr>
                            <tr><th>Block Type</th><td></td></tr>
                            <tr><th>File</th><td></td></tr>
                            <tr><th>KAT/KUT</th><td></td></tr>
                            <tr><th>RTA</th><td></td></tr>
                            <tr><th>ATT/UAT</th><td></td></tr>
                            <tr><th>Run Cycle</th><td></td></tr>
                            <tr><th>Fail Cycle/Total Cycle</th><td></td></tr>
                            <tr><th>Case Note</th><td></td></tr>
                            <tr><th>Comments</th><td></td></tr>
                            <tr><th>Component List</th><td></td></tr>
                            <tr><th>Comment</th><td></td></tr>
                            <tr><th>Category</th><td></td></tr>
                        </tbody>
                    </table>
                
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
document.addEventListener("DOMContentLoaded", function() {
    var configContainer = document.getElementById('configContainer');
    var addConfigBtn = document.getElementById('addConfig');
    var clearAllBtn = document.getElementById('clearAllBtn');

    // 添加配置行
    addConfigBtn.addEventListener('click', function() {
        addConfigRow();
    });

    // 添加配置行函数
    function addConfigRow() {
    var configRow = document.createElement('div');
    configRow.className = 'row mb-3';
    configRow.innerHTML = `
        <div class="col">
            <label>Task ID</label>
            <select class="form-select task-id-select custom-width-task-id">
                <option value="" selected>Choose Task ID</option>
                {% for row in rows %}
                <option value="{{ row['Task ID'] }}">{{ row['Task ID'] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col">
            <label>Case Title</label>
            <select class="form-select task-title-select custom-width-case-title">
                <option selected>Please choose Task ID first</option>
            </select>
        </div>
    `;
    configContainer.appendChild(configRow);

    // Initialize Select2 on the select elements
    var taskIdSelect = $(configRow).find('.task-id-select').select2();
    var taskTitleSelect = $(configRow).find('.task-title-select').select2();

    // Add change event listeners
    taskIdSelect.on('change', function() {
        var taskId = $(this).val();
        if (taskId) {
            // AJAX request to get Task Title
            $.ajax({
                url: '/get-task-title/' + taskId,
                type: 'GET',
                success: function(response) {
                    // Clear existing options
                    taskTitleSelect.empty();
                    taskTitleSelect.append('<option selected>Choose Case Title</option>');
                    response.forEach(function(title) {
                        var option = new Option(title, title);  // Use the Option constructor
                        taskTitleSelect.append(option);
                    });
                    // Update Select2
                    taskTitleSelect.select2();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        } else {
            // Clear options except the first one
            taskTitleSelect.empty();
            taskTitleSelect.append('<option selected>Please choose Task ID first</option>');
            // Update Select2
            taskTitleSelect.select2();
        }
    });

function escapeSelector(selector) {
    return selector.replace(/([!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g, '\\$1');
}


$(taskTitleSelect).on('change', function() {
    var taskId = $(taskIdSelect).val();
    var caseTitle = $(this).val();
    if (caseTitle) {
        displayTaskDetails(taskId, caseTitle);
    }
});

    }

    clearAllBtn.addEventListener('click', function() {
    // 清除所有配置
    var configRows = configContainer.querySelectorAll('.row');
    configRows.forEach(function(row) {
        configContainer.removeChild(row);
    });
    addConfigRow(); // 添加一个初始配置行

    // 清除详细信息表格数据，保留所有表头
    var tbody = document.querySelector('#detailsTable tbody');
    var rows = tbody.rows;
    for (var i = rows.length - 1; i >= 0; i--) {
        if (i >= 0) { // 保留所有表头行
            var cells = rows[i].cells;
            for (var j = cells.length - 1; j > 1; j--) { // 从第三个单元格开始删除
                rows[i].deleteCell(j);
            }
        }
    }
});

    function displayTaskDetails(taskId, caseTitle) {
    // AJAX 请求获取任务详细信息
    $.ajax({
        url: `/get-task-details/${taskId}/${caseTitle}`,
        type: 'GET',
        success: function(response) {
            var details = response[0];
            var tbody = document.querySelector('#detailsTable tbody');

            // 确保表格有足够的行来显示所有详细信息
            while (tbody.rows.length < 20) {
                var row = tbody.insertRow(-1);
                // Create two cells for Task ID and Case Title
                row.insertCell(0);
                row.insertCell(1);
            }

            // Set Task ID and Case Title in the first two cells of each row
            var rows = tbody.rows;
            rows[0].cells[0].textContent = 'Task ID';
            rows[0].cells[0].style.fontWeight = 'bold';
            rows[1].cells[0].textContent = 'Case Title';
            rows[1].cells[0].style.fontWeight = 'bold';

            // Insert a new cell for Task ID and Case Title in each row
            rows[0].insertCell(-1).textContent = taskId;
            rows[1].insertCell(-1).textContent = caseTitle;

            // 添加详细信息到新列中
            var detailKeys = [
                'Pass/Fail', 'Tester', 'Platform Name', 'SKU', 'Hw Phase', 'OBS', 'Block Type',
                'File', 'KAT/KUT', 'RTA', 'ATT/UAT', 'Run Cycle', 'Fail Cycle/Total Cycle',
                'Case Note', 'Comments', 'Component List', 'Comment', 'Category'
            ];

            detailKeys.forEach(function(key, index) {
    // Ensure there is a row for this detail
    if (index + 2 >= rows.length) {
        tbody.insertRow(-1);
    }
    
    // Set the detail name in the first cell as a <th> element
    rows[index + 2].cells[0].outerHTML = `<th>${key}</th>`;
    // Insert a new cell for the detail value
    rows[index + 2].insertCell(-1).textContent = details[key] || '';
});

        },
        error: function(error) {
            console.log(error);
        }
    });
}


    // 初始化页面时添加一个配置行
    addConfigRow();
});

</script>
    
<style>
    .container {
        min-height: calc(100% - 100px); 
        padding-bottom: 60px; 
        max-width: 90%; 
    }   

    .custom-width-task-id {
        width: 200px; 
    }

    .custom-width-case-title {
        width: 1300px;
    }

    .col{
        white-space: nowrap;
    }
    .select2-container--default .select2-selection--single {
        height: 38px;
    }
    .select2-container .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow{
        height: 26px;
        position: absolute;
        top: 6px;
        right: 1px;
        width: 20px;
    }

    #configContainer {
        background-color: #f6f6f6;
        padding: 20px 15px 10px 15px; /* 上、右、下、左的内间距 */
        border-radius: 10px;
    }

    .btn-primary {
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .btn-success {
        margin-top: 10px;
        margin-left: 10px;
        margin-bottom: 10px;
    }
    
    .row.justify-content-end{
        margin-right: 0px;
    }
</style>